<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ููุตุฉ ุญููุงุช ุงูุซุฑูุง - V6.2 Stable</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDk5PRsHGgO-i_dIEjOw-j_BjPO9kn--GI",
            authDomain: "thuraya-platform.firebaseapp.com",
            projectId: "thuraya-platform",
            storageBucket: "thuraya-platform.firebasestorage.app",
            messagingSenderId: "1055940030867",
            appId: "1:1055940030867:web:d96f6a69a342e98c6d7866",
            measurementId: "G-2QKJEQR322"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ูุญุงููุฉ ุชูุนูู ุงูุฃูููุงูู
        try { enableIndexedDbPersistence(db); } catch (e) { console.log("Offline Persistence Error", e); }

        // ุฌุนู ุงูุฏูุงู ูุชุงุญุฉ ูู React (ุญู ูุดููุฉ ุงูุดุงุดุฉ ุงูุจูุถุงุก)
        window.db = db;
        
        // ุฏุงูุฉ ุงูุญูุธ ุงูุนุงูุฉ
        window.saveToCloudGlobal = async (data) => {
            try {
                await setDoc(doc(db, "appData", "mainConfig"), data);
                return true;
            } catch (e) {
                console.error("Save Error:", e);
                return false;
            }
        };

        // ุฏุงูุฉ ุงูุงุณุชูุงุน ููุชุญุฏูุซุงุช
        window.listenToCloud = (callback) => {
            return onSnapshot(doc(db, "appData", "mainConfig"), (doc) => {
                if (doc.exists()) callback(doc.data());
            });
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const initialConfig = {
            settings: { layoutScale: 1, textScale: 1 },
            texts: {
                siteTitle: 'ุญููุงุช ุงูุซุฑูุง',
                heroTitle: 'ุฃููุงู ุจูู ูู ุญููุงุช ุงูุซุฑูุง',
                heroSubtitle: 'ุจูุฆุฉ ุชุฑุจููุฉ ุฌุงุฐุจุฉ ูุชุนููู ุงููุฑุขู ุงููุฑูู',
                weeklyQuestion: 'ูู ูู ุงูุตุญุงุจู ุงูุฐู ุงูุชุฒ ูููุชู ุนุฑุด ุงูุฑุญููุ',
                contact: { phone: '967700000000', location: '#', youtube: '#' }
            },
            news: [{ id: 1, title: 'ุฎุจุฑ ุชุฌุฑูุจู', date: '2026-02-03', content: 'ูุญุชูู ุงูุฎุจุฑ...', hidden: false, colors: {} }],
            teachers: [{ id: 1, name: 'ุงูุดูุฎ ูุญูุฏ', bio: 'ูุดุฑู', hidden: false }],
            halaqat: [],
            schedules: [{ id: 1, name: 'ุฃุจู ุจูุฑ', period: 'ุนุตุฑ', hidden: false, days: Array(6).fill({day:'', time:'', note:''}).map((_,i)=>({day:['ุณุจุช','ุฃุญุฏ','ุงุซููู','ุซูุงุซุงุก','ุฃุฑุจุนุงุก','ุฎููุณ'][i], time:'4:00', note:''})) }]
        };

        const App = () => {
            const [config, setConfig] = useState(initialConfig);
            const [page, setPage] = useState('home');
            const [isAdmin, setIsAdmin] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [toast, setToast] = useState(null);
            const [studentName, setStudentName] = useState(localStorage.getItem('st_name') || '');
            
            // ููุงูุฐ
            const [passwordInput, setPasswordInput] = useState('');
            const [loginModal, setLoginModal] = useState(false);

            // 1. ุงูุงุณุชูุงุน ููุณุญุงุจุฉ
            useEffect(() => {
                if (window.listenToCloud) {
                    const unsub = window.listenToCloud((data) => {
                        // ุฅุฐุง ููุช ุฃุฏูู ูุชุนูู ุญุงููุงูุ ูุง ุฃูุงุทุนู ุจุงูุชุญุฏูุซุ ูุฅูุง ุญุฏุซ ุงููุงุฌูุฉ
                        // (ููููู ุฅุฒุงูุฉ ุงูุดุฑุท ูุชุญุฏูุซ ููุฑู ุฏุงุฆูุงู)
                        setConfig(data);
                    });
                    return () => unsub();
                }
            }, []);

            // 2. ูุฑุงูุจุฉ ุงููุช ูุงูุญุฌู
            useEffect(() => {
                window.addEventListener('online', () => setIsOnline(true));
                window.addEventListener('offline', () => setIsOnline(false));
                document.documentElement.style.setProperty('--layout-scale', config.settings?.layoutScale || 1);
            }, [config]);

            // 3. ุฏูุงู ุงููุธุงู
            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };
            const reloadApp = () => window.location.reload();

            // ุฒุฑ ุงูุญูุธ ุงูุฃุฒุฑู ุงูุนุงุฆู
            const handleGlobalSave = async () => {
                const success = await window.saveToCloudGlobal(config);
                if(success) showToast("โ ุชู ุญูุธ ุงูุชุนุฏููุงุช ููุดุฑูุง!");
                else showToast("โ ูุดู ุงูุญูุธุ ุชุฃูุฏ ูู ุงูุฅูุชุฑูุช");
            };

            // ุชุณุฌูู ุงูุฏุฎูู
            const handleLogin = () => {
                if(passwordInput === '12345') { setIsAdmin(true); setPage('admin'); setLoginModal(false); }
                else showToast("ูููุฉ ุงููุฑูุฑ ุฎุงุทุฆุฉ");
            };

            return (
                <div id="app-container">
                    {/* ุดุฑูุท ุงูุญุงูุฉ */}
                    {!isOnline && <div className="offline-banner">ุฃูุช ุชุชุตูุญ ูุณุฎุฉ ูุญููุธุฉ (ูุง ููุฌุฏ ุฅูุชุฑูุช)</div>}
                    <div className="update-btn" onClick={reloadApp}>๐ ุชุญุฏูุซ</div>
                    {toast && <div className="toast-container"><div className="toast">{toast}</div></div>}

                    {/* ูุงูุฐุฉ ุงูุฏุฎูู */}
                    {loginModal && (
                        <div className="modal-overlay" onClick={() => setLoginModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-xl mb-4">ุฏุฎูู ุงููุดุฑู</h3>
                                <input className="w-full p-3 border rounded-xl text-center mb-4" type="password" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} autoFocus />
                                <button onClick={handleLogin} className="w-full bg-emerald-600 text-white p-3 rounded-xl font-bold">ุฏุฎูู</button>
                            </div>
                        </div>
                    )}

                    {/* ุงูููุฏุฑ */}
                    <header className="p-4 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
                        <h1 className="font-black text-emerald-800 text-lg">{config.texts.siteTitle}</h1>
                        <button onClick={() => isAdmin ? setIsAdmin(false) : setLoginModal(true)} className="bg-gray-100 p-2 rounded-lg text-xs font-bold">
                            {isAdmin ? '๐ด ุฎุฑูุฌ' : '๐ ุฅุฏุงุฑู'}
                        </button>
                    </header>

                    {/* ุงููุญุชูู */}
                    <main className="p-4 animate-in">
                        
                        {/* --- ุนุฑุถ ุงูุฒูุงุฑ (ุงูุฑุฆูุณูุฉ) --- */}
                        {page === 'home' && !isAdmin && (
                            <div className="space-y-6">
                                <div className="bg-emerald-700 text-white p-8 rounded-3xl text-center relative overflow-hidden">
                                    <div className="islamic-pattern"></div>
                                    <h2 className="relative z-10 text-2xl font-black">{config.texts.heroTitle}</h2>
                                    <p className="relative z-10 text-sm mt-2">{config.texts.heroSubtitle}</p>
                                </div>

                                <div className="space-y-4">
                                    <h3 className="font-bold border-b-2 border-amber-400 inline-block">ุขุฎุฑ ุงูุฃุฎุจุงุฑ</h3>
                                    {config.news.filter(n => !n.hidden).map(n => (
                                        <div key={n.id} className="news-card p-6">
                                            <div className="text-xs text-gray-400 mb-1">{n.date}</div>
                                            <h4 className="font-bold text-lg mb-2">{n.title}</h4>
                                            <p className="text-gray-600 text-sm">{n.content}</p>
                                        </div>
                                    ))}
                                </div>

                                {/* ุงูุฌุฏุงูู ููุฒูุงุฑ */}
                                <div className="space-y-4">
                                    <h3 className="font-bold border-b-2 border-amber-400 inline-block">ุงูุฌุฏุงูู</h3>
                                    {config.schedules.filter(s => !s.hidden).map(s => (
                                        <div key={s.id} className="bg-white rounded-xl shadow overflow-hidden">
                                            <div className="bg-emerald-600 text-white p-3 font-bold text-center">{s.name} ({s.period})</div>
                                            <table className="schedule-table">
                                                <thead><tr><th>ุงูููู</th><th>ุงูููุช</th><th>ููุงุญุธุฉ</th></tr></thead>
                                                <tbody>{s.days.map((d, i) => <tr key={i}><td>{d.day}</td><td>{d.time}</td><td>{d.note}</td></tr>)}</tbody>
                                            </table>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* --- ููุญุฉ ุงูุฅุฏุงุฑุฉ (ุงูุชุนุฏูู ุงูุณูุณ) --- */}
                        {isAdmin && (
                            <div className="pb-20">
                                {/* ุฒุฑ ุงูุญูุธ ุงูุนุงุฆู */}
                                <button onClick={handleGlobalSave} className="admin-btn-save bg-blue-600 text-white px-6 py-3 rounded-full font-black text-sm flex items-center gap-2">
                                    ๐พ ุญูุธ ููุดุฑ ุงูุชุนุฏููุงุช
                                </button>

                                <div className="admin-section">
                                    <h3>1. ุฅุนุฏุงุฏุงุช ุนุงูุฉ</h3>
                                    <label className="text-xs font-bold block mb-1">ุงุณู ุงููููุน</label>
                                    <input className="w-full p-2 border rounded mb-2" value={config.texts.siteTitle} onChange={e => setConfig({...config, texts:{...config.texts, siteTitle:e.target.value}})} />
                                    
                                    <label className="text-xs font-bold block mb-1">ุญุฌู ุงููููุน</label>
                                    <input type="range" min="0.5" max="1.2" step="0.05" className="scale-slider w-full" value={config.settings.layoutScale} onChange={e => setConfig({...config, settings:{...config.settings, layoutScale:e.target.value}})} />
                                </div>

                                <div className="admin-section">
                                    <h3>2. ุงูุฃุฎุจุงุฑ</h3>
                                    <button onClick={() => setConfig({...config, news:[{id:Date.now(), title:'', content:'', date:'2026-01-01', hidden:false}, ...config.news]})} className="bg-emerald-100 text-emerald-800 px-4 py-2 rounded font-bold text-xs mb-4">+ ุฅุถุงูุฉ ุฎุจุฑ</button>
                                    
                                    {config.news.map((n, i) => (
                                        <div key={n.id} className={`border p-3 rounded mb-2 ${n.hidden ? 'opacity-50' : ''}`}>
                                            <div className="flex justify-between mb-2">
                                                <button onClick={() => {const news = [...config.news]; news[i].hidden = !news[i].hidden; setConfig({...config, news})}} className="text-xs bg-gray-200 px-2 rounded">{n.hidden ? 'ูุญุฌูุจ' : 'ุธุงูุฑ'}</button>
                                                <button onClick={() => {const news = config.news.filter(x => x.id !== n.id); setConfig({...config, news})}} className="text-xs text-red-500 font-bold">ุญุฐู</button>
                                            </div>
                                            <input className="w-full p-2 border rounded mb-1 font-bold" value={n.title} placeholder="ุงูุนููุงู" onChange={e => {const news=[...config.news]; news[i].title=e.target.value; setConfig({...config, news})}} />
                                            <textarea className="w-full p-2 border rounded text-sm" value={n.content} placeholder="ุงูุชูุงุตูู" onChange={e => {const news=[...config.news]; news[i].content=e.target.value; setConfig({...config, news})}} />
                                        </div>
                                    ))}
                                </div>

                                <div className="admin-section">
                                    <h3>3. ุงูุฌุฏุงูู ุงูุฏุฑุงุณูุฉ</h3>
                                    {config.schedules.map((sch, schIdx) => (
                                        <div key={sch.id} className="mb-4 border-b pb-4">
                                            <input className="font-bold text-emerald-800 w-full mb-2 border-b" value={sch.name} onChange={e => {const s=[...config.schedules]; s[schIdx].name=e.target.value; setConfig({...config, schedules:s})}} />
                                            <div className="overflow-x-auto">
                                                <table className="schedule-table">
                                                    <thead><tr><th>ุงูููู</th><th>ุงูููุช</th><th>ููุงุญุธุฉ</th></tr></thead>
                                                    <tbody>
                                                        {sch.days.map((d, dIdx) => (
                                                            <tr key={dIdx}>
                                                                <td className="bg-gray-50">{d.day}</td>
                                                                <td><input className="w-full bg-transparent text-center" value={d.time} onChange={e => {
                                                                    const s = [...config.schedules];
                                                                    s[schIdx].days[dIdx].time = e.target.value;
                                                                    setConfig({...config, schedules:s});
                                                                }} /></td>
                                                                <td><input className="w-full bg-transparent text-center" value={d.note} onChange={e => {
                                                                    const s = [...config.schedules];
                                                                    s[schIdx].days[dIdx].note = e.target.value;
                                                                    setConfig({...config, schedules:s});
                                                                }} /></td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
        }
    </script>
</body>
</html>
